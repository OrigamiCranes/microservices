pipeline {
    agent any
    environment{
        DATABASE_URI = credentials("DATABASE_URI")
        AUTHOR = credentials("AUTHOR")
        VERSION = '1.0'
    }
    stages{

        stage('Test Services'){
            steps{
                sh '''
                # Test front end
                cd ./front
                python3 -m pytest --cov=app --cov-report=term-missing

                # Test Back-end
                cd ../back
                python3 -m pytest --cov=app --cov-report=term-missing

                # Test Stream
                cd ../stream
                python3 -m pytest --cov=app --cov-report=term-missing

                # Test Math
                cd ../mathy
                python3 -m pytest --cov=app --cov-report=term-missing
                cd ..
                '''
            }
        }
        stage('Build Containers and Push'){
            steps{
                sh ''' sudo chmod 666 /var/run/docker.sock
                docker-compose down --rmi all
                docker-compose build
                sudo docker login
                sudo docker-compose push
                '''
            }
        }
        stage("Configure Network"){
            steps{
                sh '''
                    cd ansible
                    chmod 666 inventory.yaml playbook.yaml
                    ls -la
                    ansible-playbook -i inventory.yaml playbook.yaml
                    cd ..
                    '''
            }
        }
        stage('Deploy Swarm'){
            steps{
                sh '''
                    scp -i ~/.ssh/ansible_id_rsa docker-compose.yml jenkins@manager:/home/jenkins/docker-compose.yaml
                    ssh -i ~/.ssh/ansible_id_rsa jenkins@manager << EOF
                    export DATABASE_URI=${DATABASE_URI}
                    export AUTHOR=${AUTHOR}
                    docker stack deploy --compose-file /home/jenkins/docker-compose.yaml microservices-stack
                '''
            }
        }
    }
}